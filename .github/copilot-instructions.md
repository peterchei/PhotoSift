# PhotoSift AI Coding Guide

- **App shape**: Windows desktop GUI built with tkinter; launcher in [src/launchPhotoSiftApp.py](src/launchPhotoSiftApp.py) routes to four tools (classification, duplicates, blur, dark). PyInstaller packaging is first-class (see [PhotoSift.spec](PhotoSift.spec), [build.bat](build.bat)).
- **Module split**: Each tool pairs a GUI file and logic file in `src/` (e.g., [ImageClassifierGUI.py](src/ImageClassifierGUI.py) + [ImageClassification.py](src/ImageClassification.py), [DuplicateImageIdentifierGUI.py](src/DuplicateImageIdentifierGUI.py) + [DuplicateImageIdentifier.py](src/DuplicateImageIdentifier.py), etc.). Keep logic testable and UI-thin.
- **Shared UI**: Reuse components from [src/CommonUI.py](src/CommonUI.py) (colors, buttons, status bar, tooltips, zoom controls, progress windows). New UI should adopt `ModernColors`, `ModernButton`, `ProgressWindow`, and styling helpers instead of ad-hoc widgets.
- **Startup/packaging quirks**: Windows/PyInstaller needs `multiprocessing.freeze_support()` and `sys._MEIPASS` path handling near the top of entrypoints. Launcher sets log output under `%LOCALAPPDATA%/PhotoSift/logs` and ensures `application_path` is on `sys.path`.
- **Model handling**: CLIP models are loaded lazily with local bundle preference ([ImageClassification.py](src/ImageClassification.py), [DuplicateImageIdentifier.py](src/DuplicateImageIdentifier.py)); they look in `models/clip-vit-base-patch32/` when frozen, otherwise fall back to download. Keep new model loads behind helpers and compatible with PyInstaller resource paths.
- **Image I/O patterns**: Use PIL for Unicode-safe loads; resize to 224x224 for CLIP; prefer batch helpers (`classify_people_vs_screenshot_batch`, `get_clip_embedding_batch`) and ThreadPoolExecutor with bounded workers (8–16). Avoid blocking the UI thread—use background threads with progress callbacks.
- **Detection logic**: Duplicate detection uses CLIP embeddings + cosine similarity matrix; classification compares prompt buckets for "people" vs "screenshot"; dark detection computes HSV Value mean with Trash-folder exclusion ([DarkImageDetection.py](src/DarkImageDetection.py)); blur detection (see [BlurryImageDetection.py](src/BlurryImageDetection.py)) uses Laplacian variance with quality buckets. Preserve thresholds and sorting semantics when extending.
- **Trash safety**: Features that scan folders skip `Trash` directories and prefer move-to-trash flows over deletes. Maintain that invariant in new scans or batch actions.
- **Concurrency**: Batch processing defaults to `min(cpu_count, 8)` workers for dark/blur scans; duplicate embedding uses vectorized similarity. When adding parallelism, cap workers and keep UI responsive (use `after`/threads, not long tkinter loops).
- **Run locally**: Activate a venv and `pip install -e .`; launch via `python src/launchPhotoSiftApp.py` for the menu, or start tool GUIs directly (e.g., `python src/DuplicateImageIdentifierGUI.py`). Models download on first run unless bundled.
- **Tests**: From repo root run `python -m unittest discover -s tests -p "test_*.py" -v` or `python tests/run_all_tests.py`. Tests assume `src` on `PYTHONPATH`, may download CLIP on first use, and create `tests/test_data/` fixtures as needed (see [tests/README.md](tests/README.md)).
- **Build**: `build.bat` creates `build_env`, installs editable deps, ensures `resources/app.ico`, then runs PyInstaller and optionally Inno Setup to produce installer in `Output/`. Keep PyInstaller-friendly imports (no dynamic module names) and place data files in `resources/` or `models/` with spec updates if you add new assets.
- **Store packaging**: Use `create_store_package.bat` and `create_store_assets.py`; see [docs/ms-store-submission.md](docs/ms-store-submission.md) and [docs/STORE_PACKAGE_CHECKLIST.md](docs/STORE_PACKAGE_CHECKLIST.md) for required asset/layout conventions.
- **Docs & demos**: Release and tutorial assets live under `docs/` and `Canva/`; demo data generator is [create_tutorial_demo.py](create_tutorial_demo.py). Update release docs when changing visible behavior.
- **UI theming**: Dark theme colors are centralized; keep new widget colors aligned. Use provided zoom controls and status bars instead of new ones to maintain consistency.
- **Logging & errors**: Launcher logs to file plus stdout; splash screen handles failures gracefully. When adding new background tasks, log errors and surface user-friendly dialogs rather than crashing tkinter mainloop.
- **Data sources**: Avoid hardcoding GPU-only paths—device selection is automatic (`cuda` if available). Respect existing file extension sets (`IMG_EXT`) and keep Unicode path support intact.
- **Performance guardrails**: Duplicate grouping builds full similarity matrix; avoid O(n^2) extensions unless gated by thresholds or batching. Keep progress callbacks for user feedback on long scans.
- **Compatibility**: Target Python 3.8+ and Windows; avoid POSIX-only paths/commands in core flows. For packaging, ensure resources are discoverable when `getattr(sys, 'frozen', False)` is true.

Have a look and let me know if any section should be clearer or if you want more detail on specific workflows.
